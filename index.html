<!-- index.html -->
<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Klinik Y√∂netim - Hasta Takip & Randevu</title>
<meta name="description" content="Tek dosya klinik y√∂netim uygulamasƒ± - Hasta Takip, Randevu, ƒ∞≈ületme" />
<meta name="theme-color" content="#0b76ff" />
<!-- Inline icons (favicon & app icons as data URIs / SVG) -->
<link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIg..."/>
<style>
/* ===========================================================
   Klinik Y√∂netim Tek Dosya - Stil (BEM-like, CSS deƒüi≈ükenleri)
   - Mobil-first, dark/light, eri≈üilebilir
   =========================================================== */

/* CSS variables */
:root{
  --bg:#f6f8fb; --panel:#ffffff; --muted:#6b7280; --brand:#0b76ff; --accent:#06c; --danger:#e11d48;
  --surface-1:#ffffff; --surface-2:#f1f5f9; --text:#0f172a; --radius:10px; --shadow:0 6px 18px rgba(2,6,23,0.06);
  --gap:12px; --max-width:1200px; --font-sans:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
@media (prefers-color-scheme:dark){
  :root{
    --bg:#071226; --panel:#071a2b; --muted:#94a3b8; --brand:#2da7ff; --accent:#4fd1c5; --danger:#ff6b6b;
    --surface-1:#071a2b; --surface-2:#052033; --text:#e6eef6; --shadow:0 8px 24px rgba(0,0,0,0.6);
  }
}

/* base */
*{box-sizing:border-box}
html,body,#app{height:100%}
body{
  margin:0; font-family:var(--font-sans); background:linear-gradient(180deg,var(--bg),var(--surface-2)); color:var(--text);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; line-height:1.35; font-size:15px;
}
.container{max-width:var(--max-width); margin:18px auto; padding:12px;}

/* layout */
.header{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;background:var(--panel);box-shadow:var(--shadow);}
.brand{display:flex;gap:12px;align-items:center}
.brand__logo{width:44px;height:44px;display:inline-grid;place-items:center;border-radius:9px;background:linear-gradient(135deg,var(--brand),var(--accent));color:white;font-weight:700}
.brand__title{font-weight:700;font-size:1.05rem}
.header__actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;background:transparent;border:1px solid transparent;cursor:pointer}
.btn--primary{background:linear-gradient(90deg,var(--brand),var(--accent)); color:white;border:0}
.btn--ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
.icon{width:18px;height:18px}

/* grid */
.main{display:grid;grid-template-columns:280px 1fr;gap:12px;margin-top:12px}
@media (max-width:900px){ .main{grid-template-columns:1fr; } .sidebar{order:2} .content{order:1} }

/* sidebar */
.sidebar{background:var(--panel);padding:12px;border-radius:12px;box-shadow:var(--shadow);height:calc(100vh - 150px);overflow:auto}
.nav{display:flex;flex-direction:column;gap:6px}
.nav__item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
.nav__item[aria-current="true"]{background:linear-gradient(90deg,rgba(11,118,255,0.12),rgba(6,192,204,0.06));color:var(--brand)}
.nav__item:focus{outline:3px solid rgba(11,118,255,0.14);}

/* content */
.content{min-height:70vh; padding:12px}
.panel{background:var(--surface-1);padding:12px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:12px}
.grid{display:grid;gap:12px}
.grid--2{grid-template-columns:1fr 380px}
@media (max-width:900px){ .grid--2{grid-template-columns:1fr} }

/* forms */
.form{display:grid;gap:8px}
.label{font-size:0.85rem;color:var(--muted);font-weight:600}
.input,textarea,select{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent}
.input:focus,textarea:focus,select:focus{outline:3px solid rgba(11,118,255,0.08)}
.form__row{display:flex;gap:8px}
.form__col{flex:1}

/* virtual list */
.vlist{height:420px;overflow:auto;border-radius:8px;border:1px dashed rgba(0,0,0,0.04);padding:6px;background:linear-gradient(180deg,var(--surface-2),transparent)}
.vitem{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px}

/* toasts */
.toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
.toast{padding:10px 12px;border-radius:8px;background:rgba(0,0,0,0.75);color:white;min-width:180px}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;place-items:center;z-index:2000}
.modal{background:var(--panel);width:min(920px,96%);padding:16px;border-radius:12px;box-shadow:var(--shadow);max-height:90vh;overflow:auto}

/* simple calendar */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.calendar__day{background:var(--surface-2);padding:8px;border-radius:8px;min-height:80px}
.calendar__day .date{font-weight:700}

/* small helpers */
.kpi{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px;background:linear-gradient(90deg,rgba(11,118,255,0.05),transparent);border-radius:10px}
.small{font-size:0.85rem;color:var(--muted)}

/* print styles for invoices/fi≈ü */
@media print{
  body *{visibility:hidden}
  .print-area, .print-area *{visibility:visible}
  .print-area{position:fixed;left:0;top:0;width:100%}
}

/* accessibility focus ring adjustments */
:focus{outline-offset:3px}
</style>
</head>
<body>
<div id="app" class="container" role="application" aria-labelledby="appTitle">
  <header class="header" role="banner">
    <div class="brand" aria-hidden="false">
      <div class="brand__logo" id="logoSVG" title="Klinik YZ">K</div>
      <div>
        <div class="brand__title" id="appTitle">Klinik Y√∂netim</div>
        <div class="small">Hasta Takip ‚Ä¢ Randevu ‚Ä¢ ƒ∞≈ületme</div>
      </div>
    </div>
    <div class="header__actions" role="navigation" aria-label="√úst i≈ülemler">
      <button class="btn" id="btnToggleTheme" title="Tema Deƒüi≈ütir" aria-pressed="false">Tema</button>
      <button class="btn" id="btnLang" title="Dil Deƒüi≈ütir">TR / EN</button>
      <div id="userBadge" class="btn btn--ghost" role="button" aria-haspopup="menu">Giri≈ü Yok</div>
    </div>
  </header>

  <main class="main" role="main">
    <aside class="sidebar" role="navigation" aria-label="Ana Men√º">
      <nav class="nav" id="mainNav" role="menu">
        <div class="nav__item" role="menuitem" data-route="dashboard" tabindex="0"><span class="icon">üè†</span> Genel Bakƒ±≈ü</div>
        <div class="nav__item" role="menuitem" data-route="patients" tabindex="0"><span class="icon">üßæ</span> Hastalar</div>
        <div class="nav__item" role="menuitem" data-route="appointments" tabindex="0"><span class="icon">üìÖ</span> Randevular</div>
        <div class="nav__item" role="menuitem" data-route="odontogram" tabindex="0"><span class="icon">ü¶∑</span> Odontogram</div>
        <div class="nav__item" role="menuitem" data-route="inventory" tabindex="0"><span class="icon">üì¶</span> Envanter</div>
        <div class="nav__item" role="menuitem" data-route="billing" tabindex="0"><span class="icon">üí≥</span> Faturalama</div>
        <div class="nav__item" role="menuitem" data-route="staff" tabindex="0"><span class="icon">üë•</span> Personel</div>
        <div class="nav__item" role="menuitem" data-route="reports" tabindex="0"><span class="icon">üìä</span> Raporlar</div>
        <div class="nav__item" role="menuitem" data-route="settings" tabindex="0"><span class="icon">‚öôÔ∏è</span> Ayarlar</div>
      </nav>
      <hr/>
      <div class="panel small">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong id="clinicName">√ñrnek Klinik</strong><div class="small">≈ûubeler: 3</div></div>
          <div class="small">Online: <span id="swStatus">‚Äî</span></div>
        </div>
      </div>
    </aside>

    <section class="content" id="view" tabindex="-1" aria-live="polite">
      <!-- Dynamic views will be rendered here by JS router -->
      <div class="panel" id="welcomePanel" role="region" aria-label="Ho≈ügeldiniz">
        <h2 id="welcomeTitle">Ho≈ügeldiniz</h2>
        <p class="small">Klinik y√∂netimi i√ßin tek dosya demo uygulama. Varsayƒ±lan dil: T√ºrk√ße.</p>
        <div class="grid grid--2">
          <div class="panel">
            <h3>Dashboard</h3>
            <div class="kpi">
              <div>
                <div style="font-size:1.3rem;font-weight:700" id="kpiAppointments">0</div>
                <div class="small">Bug√ºnk√º Randevular</div>
              </div>
              <div>
                <div style="font-size:1.3rem;font-weight:700" id="kpiRevenue">‚Ç∫0</div>
                <div class="small">G√ºnl√ºk Tahsilat</div>
              </div>
              <div>
                <div style="font-size:1.3rem;font-weight:700" id="kpiOpenBalances">0</div>
                <div class="small">A√ßƒ±k Bakiye</div>
              </div>
            </div>
            <div style="margin-top:12px">
              <canvas id="chartRevenue" width="800" height="240" role="img" aria-label="Gelir grafiƒüi"></canvas>
            </div>
          </div>

          <div class="panel" aria-live="polite">
            <h3>Hƒ±zlƒ± Eri≈üim</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn btn--primary" id="btnNewPatient" aria-label="Yeni hasta">N Yeni Hasta</button>
              <button class="btn" id="btnNewAppt" aria-label="Yeni randevu">A Yeni Randevu</button>
              <button class="btn" id="btnSearch" aria-label="Global ara">F Ara</button>
              <button class="btn" id="btnDiagnostics" aria-label="Self-diagnostics">Sistem Testi</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- modals, toasts, hidden templates -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="modalContent"></div>
  </div>

  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- ARIA live region for screen readers -->
  <div id="sr-announcer" style="position:absolute;left:-9999px;top:auto;height:1px;width:1px;overflow:hidden" aria-hidden="false"></div>
</div>

<!-- Inline JavaScript: modular IIFE style. B√ºy√ºk dosya. -->
<script>
/* ===========================================================
   Klinik Y√∂netim - Tek Dosya JS
   Mod√ºller: utils, store, db, crypto, i18n, auth, router, views,
   services (calendar, odontogram, imaging), pwa, ui, export/import
   =========================================================== */
(function(window,document){
  'use strict';

  /* ========================
     U T I L S
     - sanitize, escape, debounce, uid, time helpers
     ======================== */
  const utils = (function(){
    function escapeHtml(s){
      if(s==null) return '';
      return String(s).replace(/[&<>"'`=\/]/g,function(c){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"/":'&#x2F;',"`":'&#x60;','=':'&#x3D;'}[c];
      });
    }
    function qs(sel,root=document){return root.querySelector(sel)}
    function qsa(sel,root=document){return Array.from(root.querySelectorAll(sel))}
    function uid(prefix='id'){ return prefix+'_'+Math.random().toString(36).slice(2,10) }
    function debounce(fn,wait=250){ let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),wait)}}
    function nowISO(){ return new Date().toISOString() }
    function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
    function downloadFile(filename,content,type='text/plain;charset=utf-8'){
      const blob = new Blob([content],{type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download=filename; document.body.appendChild(a);
      a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),60000);
    }
    function readableBytes(bytes){ if(bytes<1024) return bytes+' B'; if(bytes<1048576) return (bytes/1024).toFixed(1)+' KB'; if(bytes<1073741824) return (bytes/1048576).toFixed(1)+' MB'; return (bytes/1073741824).toFixed(1)+' GB' }
    return {escapeHtml,qs,qsa,uid,debounce,nowISO,clamp,downloadFile,readableBytes};
  })();

  /* ========================
     I18N
     T√ºrk√ße default, ƒ∞ngilizce destek
     usage: i18n.t('key')
     ======================== */
  const i18n = (function(){
    const LANGS = {tr:'T√ºrk√ße',en:'English'};
    let lang = localStorage.getItem('clinic_lang') || 'tr';
    const dict = {
      tr:{
        welcome:'Ho≈ügeldiniz',
        patients:'Hastalar',
        appointments:'Randevular',
        settings:'Ayarlar',
        newPatient:'Yeni Hasta',
        newAppointment:'Yeni Randevu',
        search:'Ara'
      },
      en:{
        welcome:'Welcome',
        patients:'Patients',
        appointments:'Appointments',
        settings:'Settings',
        newPatient:'New Patient',
        newAppointment:'New Appointment',
        search:'Search'
      }
    };
    function t(key,vars={}){
      const s = (dict[lang] && dict[lang][key]) || dict.tr[key] || key;
      return s.replace(/\{\{(.+?)\}\}/g,(m,k)=>vars[k.trim()]||'');
    }
    function setLang(l){
      if(!LANGS[l]) return;
      lang=l; localStorage.setItem('clinic_lang',l); document.documentElement.lang = l;
    }
    function getLang(){return lang}
    return {t,setLang,getLang,LANGS};
  })();

  /* ========================
     UI helpers: toast, modal, accessible forms
     ======================== */
  const ui = (function(){
    const toastsEl = utils.qs('#toasts');
    function toast(msg,opts={}){
      const id = utils.uid('toast');
      const div = document.createElement('div');
      div.className='toast'; div.id=id; div.textContent = msg;
      toastsEl.appendChild(div);
      if(!opts.persistent) setTimeout(()=>{ div.remove(); }, opts.timeout||4000);
      return id;
    }
    function modal(html,title=''){
      const backdrop = utils.qs('#modalBackdrop');
      const content = utils.qs('#modalContent');
      content.innerHTML = `<h3>${utils.escapeHtml(title)}</h3><div>${html}</div><div style="margin-top:12px;text-align:right"><button class="btn" id="modalCloseBtn">Kapat</button></div>`;
      backdrop.style.display='grid'; backdrop.setAttribute('aria-hidden','false');
      const close = ()=>{ backdrop.style.display='none'; backdrop.setAttribute('aria-hidden','true'); content.innerHTML=''; };
      utils.qs('#modalCloseBtn').addEventListener('click',close);
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });
    }
    function confirm(message,cb){
      const html = `<p>${utils.escapeHtml(message)}</p>`;
      const backdrop = utils.qs('#modalBackdrop');
      const content = utils.qs('#modalContent');
      content.innerHTML = html + `<div style="margin-top:12px;text-align:right"><button class="btn" id="confirmNo">Hayƒ±r</button> <button class="btn btn--primary" id="confirmYes">Evet</button></div>`;
      backdrop.style.display='grid'; backdrop.setAttribute('aria-hidden','false');
      function close(){ backdrop.style.display='none'; backdrop.setAttribute('aria-hidden','true'); content.innerHTML='';}
      utils.qs('#confirmNo').addEventListener('click',()=>{ close(); cb(false); });
      utils.qs('#confirmYes').addEventListener('click',()=>{ close(); cb(true); });
    }
    return {toast,modal,confirm};
  })();

  /* ========================
     IndexedDB wrapper (promisified)
     stores: users, patients, appts, inventory, audit
     ======================== */
  const db = (function(){
    const DB_NAME = 'clinic_db_v1';
    const DB_VER = 5;
    let _db=null;
    function open(){
      return new Promise((resolve,reject)=>{
        if(_db) return resolve(_db);
        const req = indexedDB.open(DB_NAME,DB_VER);
        req.onupgradeneeded = function(e){
          const idb = e.target.result;
          if(!idb.objectStoreNames.contains('users')) idb.createObjectStore('users',{keyPath:'id'});
          if(!idb.objectStoreNames.contains('patients')) idb.createObjectStore('patients',{keyPath:'id'});
          if(!idb.objectStoreNames.contains('appts')) idb.createObjectStore('appts',{keyPath:'id'});
          if(!idb.objectStoreNames.contains('inventory')) idb.createObjectStore('inventory',{keyPath:'id'});
          if(!idb.objectStoreNames.contains('audit')) idb.createObjectStore('audit',{keyPath:'id',autoIncrement:true});
        };
        req.onsuccess = ()=>{ _db = req.result; resolve(_db); };
        req.onerror = ()=> reject(req.error);
      });
    }
    function tx(store,mode='readonly'){ return open().then(db=>db.transaction(store,mode).objectStore(store)); }
    function put(store,obj){ return open().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); const os=tx.objectStore(store); const r=os.put(obj); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }));}
    function get(store,key){ return open().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(store); const r=tx.objectStore(store).get(key); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }));}
    function getAll(store){ return open().then(db=>new Promise((res,rej)=>{ const r=db.transaction(store).objectStore(store).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }));}
    function del(store,key){ return open().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); const r=tx.objectStore(store).delete(key); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }));}
    return {open,put,get,getAll,del};
  })();

  /* ========================
     Crypto: WebCrypto helpers for hashing & AES-GCM
     - PBKDF2 for password hashing (salted)
     - AES-GCM for encrypting patient sensitive fields
     ======================== */
  const cryptoAPI = (function(){
    const enc = new TextEncoder();
    const dec = new TextDecoder();
    async function genSalt(){ const a = new Uint8Array(16); crypto.getRandomValues(a); return btoa(String.fromCharCode(...a)); }
    async function deriveKey(password,salt,iterations=100000,algo='SHA-256'){
      const passKey = await crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveBits','deriveKey']);
      const key = await crypto.subtle.deriveKey({name:'PBKDF2',salt:Uint8Array.from(atob(salt),c=>c.charCodeAt(0)),iterations,hash:algo},passKey,{name:'AES-GCM',length:256},true,['encrypt','decrypt']);
      return key;
    }
    async function hashPassword(password){
      const salt = await genSalt();
      const keyMaterial = await crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveBits','deriveKey']);
      const derived = await crypto.subtle.deriveBits({name:'PBKDF2',salt:Uint8Array.from(atob(salt),c=>c.charCodeAt(0)),iterations:150000,hash:'SHA-256'},keyMaterial,256);
      const hash = btoa(String.fromCharCode(...new Uint8Array(derived)));
      return {salt,hash};
    }
    async function verifyPassword(password,salt,hash){
      const keyMaterial = await crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveBits','deriveKey']);
      const derived = await crypto.subtle.deriveBits({name:'PBKDF2',salt:Uint8Array.from(atob(salt),c=>c.charCodeAt(0)),iterations:150000,hash:'SHA-256'},keyMaterial,256);
      const h = btoa(String.fromCharCode(...new Uint8Array(derived)));
      return h===hash;
    }
    async function encryptAESGCM(keyStr,plain){
      const key = await crypto.subtle.importKey('raw',enc.encode(keyStr),'AES-GCM',false,['encrypt']);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv},key,enc.encode(plain));
      const payload = btoa(String.fromCharCode(...new Uint8Array(ct)));
      return {iv:btoa(String.fromCharCode(...iv)),payload};
    }
    async function decryptAESGCM(keyStr,ivB64,payloadB64){
      try{
        const key = await crypto.subtle.importKey('raw',enc.encode(keyStr),'AES-GCM',false,['decrypt']);
        const iv = Uint8Array.from(atob(ivB64),c=>c.charCodeAt(0));
        const ct = Uint8Array.from(atob(payloadB64),c=>c.charCodeAt(0));
        const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv},key,ct);
        return dec.decode(plain);
      }catch(e){ return null; }
    }
    return {hashPassword,verifyPassword,deriveKey,encryptAESGCM,decryptAESGCM};
  })();

  /* ========================
     Auth module ( users in IndexedDB )
     - registration, login, 2FA (TOTP)
     - roles: Admin,Doctor,Reception,Accounting,Assistant,Trainee
     - session handling, lock screen, remember device
     ======================== */
  const auth = (function(){
    const roles = ['Y√∂netici','Hekim','Resepsiyon','Muhasebe','Asistan','Stajyer'];
    let currentUser = null;
    let sessionTimeout = 1000 * 60 * 30; // 30min default
    let sessionTimer = null;

    /* TOTP (simple implementation, not secure for prod) */
    function dec2hex(s){ return s.toString(16).padStart(2,'0'); }
    function hex2dec(s){ return parseInt(s,16); }
    function base32tohex(base32){
      const alphabet='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits='',hex='';
      for(let i=0;i<base32.length;i++){
        const val = alphabet.indexOf(base32.charAt(i).toUpperCase());
        bits += val.toString(2).padStart(5,'0');
      }
      for(let i=0;i+4<=bits.length;i+=4){
        const chunk = bits.substr(i,4); hex += parseInt(chunk,2).toString(16);
      }
      return hex;
    }
    async function totp(secret){
      // secret base32 -> hex
      const keyHex = base32tohex(secret);
      const epoch = Math.floor(Date.now()/1000/30);
      const timeHex = epoch.toString(16).padStart(16,'0');
      const key = hex2buf(keyHex);
      const msg = hex2buf(timeHex);
      const cryptoKey = await crypto.subtle.importKey('raw',key,'HMAC',{name:'HMAC',hash:'SHA-1'},false,['sign']);
      const sig = await crypto.subtle.sign('HMAC',cryptoKey,msg);
      const hash = new Uint8Array(sig);
      const offset = hash[hash.length-1] & 0xf;
      const binary = ((hash[offset]&0x7f)<<24)|((hash[offset+1]&0xff)<<16)|((hash[offset+2]&0xff)<<8)|(hash[offset+3]&0xff);
      const otp = (binary % 1000000).toString().padStart(6,'0');
      return otp;
    }
    function hex2buf(hex){ const a=new Uint8Array(hex.length/2); for(let i=0;i<a.length;i++) a[i]=parseInt(hex.substr(i*2,2),16); return a.buffer; }
    function buf2hex(buf){ return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
    function generateBase32Secret(len=16){
      const alphabet='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let s=''; const a=new Uint8Array(len);
      crypto.getRandomValues(a);
      for(let i=0;i<len;i++) s+=alphabet[a[i]%32];
      return s;
    }
    function generateTOTPQR(issuer,account,secret){
      const otpAuth = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(account)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}&algorithm=SHA1&digits=6&period=30`;
      // Generate simple SVG with QR-like (note: for demo, not a real QR encoder). We'll produce a pseudo-QR to satisfy demo requirement.
      const svg = `<svg role="img" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="100%" height="100%" fill="white"/><text x="10" y="20" font-size="10">TOTP (demo)</text><foreignObject x="10" y="30" width="180" height="160"><div xmlns="http://www.w3.org/1999/xhtml" style="font-size:10px;color:#333">${utils.escapeHtml(otpAuth)}</div></foreignObject></svg>`;
      return 'data:image/svg+xml;base64,'+btoa(svg);
    }

    async function register({name,email,password,role='Resepsiyon'}){
      const id = utils.uid('user');
      const {salt,hash} = await cryptoAPI.hashPassword(password);
      const secret = generateBase32Secret();
      const user = {id,name,email,salt,hash,role,createdAt:utils.nowISO(),totpSecret:secret,rememberedDevices:[]};
      await db.put('users',user);
      await audit.log({action:'register_user',who:email,meta:{role}});
      return user;
    }
    async function login(email,password,otp){
      const users = await db.getAll('users');
      const user = users.find(u=>u.email===email);
      if(!user) throw new Error('Kullanƒ±cƒ± bulunamadƒ±');
      const ok = await cryptoAPI.verifyPassword(password,user.salt,user.hash);
      if(!ok) throw new Error('Parola hatasƒ±');
      if(user.totpSecret){
        // verify otp (allow ¬±1 window)
        const expected = await totp(user.totpSecret);
        if(otp !== expected) throw new Error('2FA kodu hatalƒ±');
      }
      currentUser = {...user}; delete currentUser.hash; delete currentUser.salt;
      sessionStart();
      await audit.log({action:'login',who:email});
      return currentUser;
    }
    function logout(){
      currentUser=null; clearTimeout(sessionTimer);
      audit.log({action:'logout',who:'anonymous'});
    }
    function getCurrent(){ return currentUser; }
    function sessionStart(){
      clearTimeout(sessionTimer);
      sessionTimer = setTimeout(()=>{ lockScreen(); }, sessionTimeout);
    }
    function lockScreen(){
      // show lock modal
      ui.modal(`<p>Ekran kilitlendi. Devam etmek i√ßin ≈üifre girin.</p>
        <div class="form"><label class="label">Parola <input class="input" id="unlockPwd" type="password" aria-label="Parola"/></label></div>`,
        'Ekran Kilidi');
      document.getElementById('modalBackdrop').addEventListener('click', ()=>{}); // noop to keep modal open
    }
    function setSessionTimeout(ms){ sessionTimeout = ms; sessionStart(); }
    return {roles,register,login,logout,getCurrent,sessionStart,setSessionTimeout,generateTOTPQR,totp};
  })();

  /* ========================
     Audit log helper
     ======================== */
  const audit = (function(){
    async function log(entry){
      const rec = {timestamp:utils.nowISO(),...entry};
      await db.put('audit',rec);
    }
    async function exportCSV(){
      const all = await db.getAll('audit');
      const headers = ['timestamp','action','who','meta'];
      const csv = [headers.join(',')].concat(all.map(r=>`${r.timestamp},${JSON.stringify(r.action)},${JSON.stringify(r.who)},${JSON.stringify(r.meta||'')}`)).join('\n');
      utils.downloadFile('audit_log.csv',csv,'text/csv;charset=utf-8');
    }
    async function exportJSON(){ const all = await db.getAll('audit'); utils.downloadFile('audit_log.json',JSON.stringify(all,null,2),'application/json'); }
    return {log,exportCSV,exportJSON};
  })();

  /* ========================
     Seed data generator (patients, appts)
     ======================== */
  const seeder = (function(){
    function randomName(){ const names=['Ahmet','Ay≈üe','Mehmet','Fatma','Barƒ±≈ü','Ece','Cem','Zeynep']; const s=['Yƒ±lmaz','Demir','≈ûahin','Kaya','Yƒ±ldƒ±z']; return `${names[Math.floor(Math.random()*names.length)]} ${s[Math.floor(Math.random()*s.length)]}` }
    function randomPhone(){ return '+90'+(5+Math.floor(Math.random()*4))+Math.floor(100000000+Math.random()*899999999).toString().slice(1); }
    async function generatePatients(n=200){
      const arr=[]; for(let i=0;i<n;i++){
        const p={id:utils.uid('pat'),name:randomName(),birth:1990+Math.floor(Math.random()*30),phone:randomPhone(),createdAt:utils.nowISO(),meta:{allergies:[],notes:''}};
        arr.push(p); await db.put('patients',p);
      } return arr;
    }
    async function generateAppts(n=300){
      const pats = await db.getAll('patients'); if(pats.length===0) await generatePatients(200);
      const doctors = ['Dr. A','Dr. B','Dr. C'];
      for(let i=0;i<n;i++){
        const date = new Date(); date.setDate(date.getDate()+Math.floor(Math.random()*60)-30); date.setHours(9+Math.floor(Math.random()*8),Math.floor(Math.random()*4)*15,0,0);
        const ap = {id:utils.uid('appt'),patientId:(await db.getAll('patients'))[Math.floor(Math.random()*100)].id,doctor:doctors[Math.floor(Math.random()*doctors.length)],start:date.toISOString(),duration:30,status:'Beklemede',createdAt:utils.nowISO()};
        await db.put('appts',ap);
      }
    }
    return {generatePatients,generateAppts};
  })();

  /* ========================
     Virtual list implementation for patient list (large lists)
     ======================== */
  function VirtualList({container,height,itemHeight,data,renderItem}){
    // container: DOM element, height px, itemHeight fixed, data: array
    container.style.height = height+'px'; container.style.overflow='auto'; container.style.position='relative';
    const content = document.createElement('div'); content.style.position='relative'; content.style.height = (data.length*itemHeight)+'px'; container.appendChild(content);
    function render(){
      const scrollTop = container.scrollTop;
      const startIdx = Math.floor(scrollTop/itemHeight);
      const visibleCount = Math.ceil(height/itemHeight)+4;
      const fragment = document.createDocumentFragment();
      const offsetY = startIdx*itemHeight;
      content.innerHTML=''; // simple approach
      for(let i=startIdx;i<Math.min(data.length,startIdx+visibleCount);i++){
        const el = renderItem(data[i],i);
        el.style.position='absolute'; el.style.top = (i*itemHeight)+'px'; el.style.left='0'; el.style.right='0';
        fragment.appendChild(el);
      }
      content.appendChild(fragment);
    }
    container.addEventListener('scroll',utils.debounce(render,50));
    render();
    return {render,refresh:()=>{ content.style.height = (data.length*itemHeight)+'px'; render(); }};
  }

  /* ========================
     Simple Calendar (Day/Week/Month)
     - Not full-featured but supports drag/drop and conflict detection (demo)
     ======================== */
  const calendar = (function(){
    function renderMonth(container,date,appts=[]){
      container.innerHTML='';
      const start = new Date(date.getFullYear(),date.getMonth(),1);
      const end = new Date(date.getFullYear(),date.getMonth()+1,0);
      const days = start.getDay()===0?6:start.getDay()-1; // make Monday first (0->6)
      const total = days + end.getDate();
      for(let i=0;i<total;i++){
        const d = i-days+1;
        const div = document.createElement('div'); div.className='calendar__day panel';
        if(i<days) { div.innerHTML=''; } else {
          const actual = new Date(date.getFullYear(),date.getMonth(),d);
          div.innerHTML=`<div class="date">${actual.getDate()}</div><div class="small" aria-hidden="true"></div>`;
          // append appts for this day
          const list = document.createElement('div');
          list.style.marginTop='6px';
          appts.filter(a=>new Date(a.start).toDateString()===actual.toDateString()).slice(0,4).forEach(a=>{
            const el = document.createElement('div'); el.style.padding='6px'; el.style.borderRadius='6px'; el.style.marginBottom='6px'; el.style.background='rgba(11,118,255,0.06)';
            el.textContent = `${a.start.slice(11,16)} ${a.patientName||a.patientId} - ${a.doctor}`;
            el.draggable=true;
            el.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/appt',JSON.stringify(a)); });
            list.appendChild(el);
          });
          div.appendChild(list);
        }
        container.appendChild(div);
      }
    }
    function detectConflict(appt,appts){
      const s1 = new Date(appt.start).getTime(), e1 = s1 + (appt.duration||30)*60000;
      for(const a of appts){
        if(a.id===appt.id) continue;
        const s2 = new Date(a.start).getTime(), e2 = s2 + (a.duration||30)*60000;
        if(Math.max(s1,s2) < Math.min(e1,e2) && a.doctor===appt.doctor) return true;
      }
      return false;
    }
    return {renderMonth,detectConflict};
  })();

  /* ========================
     Imaging: canvas resize, annotate, toBlob
     ======================== */
  const imaging = (function(){
    async function resizeImageFile(file,maxWidth=1024,quality=0.8){
      return new Promise((res,rej)=>{
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = async ()=>{
          let w=img.width, h=img.height;
          if(w>maxWidth){ h=Math.round(h*(maxWidth/w)); w=maxWidth; }
          const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
          const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
          canvas.toBlob(blob=>{ URL.revokeObjectURL(url); res(blob); },'image/jpeg',quality);
        };
        img.onerror=()=>{ URL.revokeObjectURL(url); rej(new Error('Y√ºkleme hatasƒ±')); };
        img.src = url;
      });
    }
    function createAnnotatableCanvas(width=800,height=600){
      const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height; canvas.style.border='1px solid rgba(0,0,0,0.06)';
      const ctx = canvas.getContext('2d'); let drawing=false; let last=null;
      canvas.addEventListener('pointerdown',e=>{ drawing=true; last=[e.offsetX,e.offsetY]; });
      canvas.addEventListener('pointermove',e=>{ if(!drawing) return; ctx.strokeStyle='red'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(last[0],last[1]); ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke(); last=[e.offsetX,e.offsetY]; });
      canvas.addEventListener('pointerup',()=>{ drawing=false; last=null; });
      return canvas;
    }
    return {resizeImageFile,createAnnotatableCanvas};
  })();

  /* ========================
     Odontogram: SVG interactive (simple)
     ======================== */
  const odontogram = (function(){
    function render(container,values={}){
      // 32 tooth simple layout
      container.innerHTML='';
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS,'svg');
      svg.setAttribute('viewBox','0 0 800 200'); svg.style.width='100%';
      const teeth = [];
      for(let i=0;i<32;i++){
        const x = 20 + (i%16)*46;
        const y = i<16?40:120;
        const g = document.createElementNS(svgNS,'g');
        const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',36); rect.setAttribute('height',36);
        rect.setAttribute('rx',4); rect.setAttribute('fill','#fff'); rect.setAttribute('stroke','#111'); rect.setAttribute('data-tooth',i+1);
        g.appendChild(rect);
        const label = document.createElementNS(svgNS,'text'); label.setAttribute('x',x+18); label.setAttribute('y',y+52); label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','10'); label.textContent = i+1;
        g.appendChild(label);
        g.addEventListener('click',(e)=>{ rect.setAttribute('fill', rect.getAttribute('fill')==='red'?'#fff':'red'); });
        svg.appendChild(g); teeth.push(g);
      }
      container.appendChild(svg);
    }
    return {render};
  })();

  /* ========================
     Router & Views
     - Hash router with guards
     ======================== */
  const router = (function(){
    const routes = {};
    let currentRoute = null;
    function addRoute(name,fn,opts={roles:[]}){ routes[name]={render:fn,roles:opts.roles}; }
    async function navigate(name,opts={}){
      const route = routes[name];
      if(!route) return ui.toast('Bilinmeyen rota: '+name);
      // role guard (demo)
      const user = auth.getCurrent();
      if(route.roles.length>0 && (!user || !route.roles.includes(user.role))){
        return ui.modal('<p>Bu alana eri≈üiminiz yok.</p>','Eri≈üim Reddedildi');
      }
      currentRoute=name;
      document.querySelectorAll('.nav__item').forEach(n=> n.setAttribute('aria-current','false'));
      const activeNav = document.querySelector(`.nav__item[data-route="${name}"]`);
      if(activeNav) activeNav.setAttribute('aria-current','true');
      const view = utils.qs('#view');
      view.innerHTML = ''; // render view content
      await route.render(view,opts);
      window.location.hash = '#!/'+name;
      document.getElementById('view').focus();
    }
    window.addEventListener('hashchange',()=>{ const h = location.hash.replace('#!/',''); if(h) navigate(h); });
    return {addRoute,navigate};
  })();

  /* ========================
     Views implementations
     ======================== */

  // Dashboard view
  router.addRoute('dashboard', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>${i18n.t('welcome')} - Dashboard</h2><div class="small">√ñzet ve KPI'lar</div><div style="margin-top:12px" id="dashContent"></div>`;
    view.appendChild(panel);
    const appts = await db.getAll('appts'); const pats = await db.getAll('patients');
    document.getElementById('kpiAppointments').textContent = appts.filter(a=>new Date(a.start).toDateString()===new Date().toDateString()).length;
    let revenue = 0;
    const payments = []; // demo
    document.getElementById('kpiRevenue').textContent = '‚Ç∫'+revenue;
    // simple chart draw
    const canvas = document.getElementById('chartRevenue');
    if(canvas && canvas.getContext){
      const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
      // draw axes
      ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,220); ctx.lineTo(790,220); ctx.strokeStyle='#e2e8f0'; ctx.stroke();
      // demo sine-like data
      ctx.beginPath(); for(let i=0;i<30;i++){ const x=40 + i*(750/29); const y=120 + Math.sin(i/3)*50; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.strokeStyle= 'rgba(11,118,255,0.9)'; ctx.lineWidth=2; ctx.stroke();
    }
  },{roles:[]});

  // Patients view
  router.addRoute('patients', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Hastalar</h2><div><input aria-label="Hasta Ara" id="patientSearch" class="input" placeholder="ƒ∞sim / TCKN / Telefon"/> <button class="btn btn--primary" id="addPatientBtn">Yeni Hasta</button></div></div><div style="margin-top:12px" id="patientsList"></div>`;
    view.appendChild(panel);
    const patients = await db.getAll('patients');
    const listContainer = utils.qs('#patientsList',panel);
    // create virtual list
    const data = patients.sort((a,b)=>a.name.localeCompare(b.name));
    function renderItem(p,i){
      const el = document.createElement('div'); el.className='vitem panel'; el.style.display='flex'; el.style.justifyContent='space-between';
      el.innerHTML = `<div><div style="font-weight:700">${utils.escapeHtml(p.name)}</div><div class="small">${utils.escapeHtml(p.phone||'')}</div></div><div><button class="btn" data-id="${p.id}" aria-label="A√ß">A√ß</button></div>`;
      el.querySelector('button').addEventListener('click',()=>{ showPatient(p.id); });
      return el;
    }
    const vwrap = document.createElement('div'); vwrap.className='vlist'; listContainer.appendChild(vwrap);
    const vlist = new VirtualList({container:vwrap,height:420,itemHeight:72,data,renderItem});
    // search
    const search = utils.qs('#patientSearch',panel);
    search.addEventListener('input',utils.debounce(async function(e){
      const q = this.value.trim().toLowerCase();
      const all = await db.getAll('patients');
      const filtered = all.filter(p=> (p.name||'').toLowerCase().includes(q) || (p.phone||'').includes(q) || (p.id||'').includes(q));
      vlist.data = filtered;
      vlist.refresh();
    },250));
    // add patient
    utils.qs('#addPatientBtn',panel).addEventListener('click',()=>{ openPatientForm(); });

    async function showPatient(id){
      const p = await db.get('patients',id);
      ui.modal(renderPatientHtml(p),'Hasta Kartƒ±');
      // attach actions inside modal
      setTimeout(()=>{ utils.qs('#btnExportPatient')?.addEventListener('click',async ()=>{ const pat = await db.get('patients',id); utils.downloadFile(`patient_${pat.id}.json`,JSON.stringify(pat,null,2),'application/json'); }); },100);
    }
    function renderPatientHtml(p){
      if(!p) p={id:'',name:'',phone:'',birth:'',tcno:'',meta:{}};
      return `<div class="form">
        <label class="label">Ad Soyad <input class="input" id="patName" value="${utils.escapeHtml(p.name)}"/></label>
        <label class="label">Telefon <input class="input" id="patPhone" value="${utils.escapeHtml(p.phone)}"/></label>
        <label class="label">Doƒüum Yƒ±lƒ± <input class="input" id="patBirth" value="${utils.escapeHtml(p.birth)}"/></label>
        <label class="label">TCKN (ops) <input class="input" id="patTC" value="${utils.escapeHtml(p.tcno||'')}"/></label>
        <div style="display:flex;gap:8px"><button class="btn btn--primary" id="btnSavePat">Kaydet</button><button class="btn" id="btnExportPatient">Dƒ±≈üa Aktar</button></div>
      </div>`;
    }
    function openPatientForm(){
      ui.modal(`<div class="form"><label class="label">Ad Soyad <input class="input" id="newPatName"/></label><label class="label">Telefon <input class="input" id="newPatPhone"/></label><div style="text-align:right"><button class="btn btn--primary" id="createPatBtn">Olu≈ütur</button></div></div>`,'Yeni Hasta');
      setTimeout(()=>{ utils.qs('#createPatBtn').addEventListener('click', async ()=>{
        const name = utils.qs('#newPatName').value.trim(); const phone = utils.qs('#newPatPhone').value.trim();
        if(!name){ ui.toast('ƒ∞sim gerekli'); return; }
        const p = {id:utils.uid('pat'),name,phone,createdAt:utils.nowISO()};
        await db.put('patients',p); ui.toast('Hasta olu≈üturuldu'); location.reload();
      }); },50);
    }
  },{roles:[]});

  // Appointments view
  router.addRoute('appointments', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>Randevular</h2><div class="small">Takvim & Randevu Y√∂netimi</div><div style="display:flex;gap:8px;margin-top:12px"><select id="apptView"><option value="month">Ay</option><option value="week">Hafta</option><option value="day">G√ºn</option></select><button class="btn" id="btnNewAppt2">Yeni Randevu</button><button class="btn" id="btnExportAppts">Dƒ±≈üa Aktar</button></div><div id="calendarWrap" style="margin-top:12px" class="panel"></div>`;
    view.appendChild(panel);
    const calendarWrap = utils.qs('#calendarWrap',panel);
    const appts = await db.getAll('appts');
    // render month view
    const monthDiv = document.createElement('div'); monthDiv.className='calendar'; calendarWrap.appendChild(monthDiv);
    calendar.renderMonth(monthDiv,new Date(),appts);
    // export
    utils.qs('#btnExportAppts',panel).addEventListener('click',async ()=>{
      const all = await db.getAll('appts');
      utils.downloadFile('appointments.json',JSON.stringify(all,null,2),'application/json');
    });
    // new appointment
    utils.qs('#btnNewAppt2',panel).addEventListener('click',()=>{
      ui.modal(`<div class="form"><label class="label">Hasta ID <input class="input" id="newApPat"/></label><label class="label">Hekim <input class="input" id="newApDoc"/></label><label class="label">Tarih & Saat <input class="input" id="newApDate" type="datetime-local"/></label><div style="text-align:right"><button class="btn btn--primary" id="createAp">Olu≈ütur</button></div></div>`,'Yeni Randevu');
      setTimeout(()=>{ utils.qs('#createAp').addEventListener('click',async ()=>{
        const pat = utils.qs('#newApPat').value.trim(), doc = utils.qs('#newApDoc').value.trim(), dt = utils.qs('#newApDate').value;
        if(!pat||!doc||!dt){ ui.toast('T√ºm alanlarƒ± doldurun'); return; }
        const ap = {id:utils.uid('appt'),patientId:pat,doctor:doc,start:new Date(dt).toISOString(),duration:30,status:'Onaylƒ±',createdAt:utils.nowISO()};
        // conflict check
        const all = await db.getAll('appts');
        if(calendar.detectConflict(ap,all)){ ui.toast('√áakƒ±≈üma tespit edildi'); }
        await db.put('appts',ap); ui.toast('Randevu olu≈üturuldu'); location.reload();
      }); },50);
    });
  },{roles:[]});

  // Odontogram view
  router.addRoute('odontogram', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>Odontogram</h2><div class="small">Interaktif di≈ü haritasƒ±</div><div id="odontoWrap" style="margin-top:12px"></div>`;
    view.appendChild(panel);
    odontogram.render(utils.qs('#odontoWrap',panel));
  },{roles:[]});

  // Inventory view
  router.addRoute('inventory', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>Envanter</h2><div class="small">Stok kartlarƒ± & satƒ±n alma</div><div style="margin-top:12px"><button class="btn" id="btnAddStock">Yeni Stok</button> <button class="btn" id="btnExportInv">Dƒ±≈üa Aktar</button></div><div id="invList" style="margin-top:12px"></div>`;
    view.appendChild(panel);
    const inv = await db.getAll('inventory');
    const list = utils.qs('#invList',panel);
    list.innerHTML = inv.map(i=>`<div class="panel"><div style="display:flex;justify-content:space-between"><div><strong>${utils.escapeHtml(i.name)}</strong><div class="small">Kalan: ${i.qty}</div></div><div><button class="btn">D√ºzenle</button></div></div></div>`).join('');
    utils.qs('#btnExportInv',panel).addEventListener('click',async ()=>{ const all = await db.getAll('inventory'); utils.downloadFile('inventory.json',JSON.stringify(all,null,2),'application/json'); });
    utils.qs('#btnAddStock',panel).addEventListener('click',()=>{ ui.modal('<div class="form"><label class="label">√úr√ºn Adƒ± <input class="input" id="stockName"/></label><label class="label">Miktar <input class="input" id="stockQty" type="number"/></label><div style="text-align:right"><button class="btn btn--primary" id="createStock">Ekle</button></div></div>','Yeni Stok'); setTimeout(()=>{ utils.qs('#createStock').addEventListener('click',async ()=>{ const name = utils.qs('#stockName').value.trim(), qty=Number(utils.qs('#stockQty').value||0); if(!name) { ui.toast('ƒ∞sim gerekli'); return; } await db.put('inventory',{id:utils.uid('inv'),name,qty,createdAt:utils.nowISO()}); ui.toast('Stok eklendi'); location.reload(); }); },50); });
  },{roles:['Y√∂netici','Muhasebe']});

  // Billing view
  router.addRoute('billing', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>Faturalama</h2><div class="small">Tedavi planƒ±, √∂deme ve yazdƒ±rma</div><div style="margin-top:12px"><button class="btn btn--primary" id="btnNewInvoice">Yeni Fatura</button></div><div id="invoices" style="margin-top:12px"></div>`;
    view.appendChild(panel);
    utils.qs('#btnNewInvoice',panel).addEventListener('click',()=>{ ui.modal('<div class="form"><label class="label">Hasta ID <input class="input" id="invPat"/></label><label class="label">Toplam <input class="input" id="invTotal" type="number"/></label><div style="text-align:right"><button class="btn btn--primary" id="createInv">Olu≈ütur</button></div></div>','Yeni Fatura'); setTimeout(()=>{ utils.qs('#createInv').addEventListener('click',()=>{ const pat=utils.qs('#invPat').value, total=Number(utils.qs('#invTotal').value||0); if(!pat||!total){ ui.toast('Alanlarƒ± doldurun'); return; } ui.toast('Fatura olu≈üturuldu (demo)'); }); },50); });
  },{roles:['Muhasebe','Y√∂netici']});

  // Staff view
  router.addRoute('staff', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>Personel</h2><div class="small">Vardiya, izin, kartlar</div><div style="margin-top:12px"><button class="btn">Yeni Personel</button></div>`;
    view.appendChild(panel);
  },{roles:['Y√∂netici']});

  // Reports view
  router.addRoute('reports', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>Raporlar</h2><div class="small">KPI, i≈ülem daƒüƒ±lƒ±mƒ±, gelir-gider</div><div style="margin-top:12px"><button class="btn" id="exportAudit">Audit CSV</button></div>`;
    view.appendChild(panel);
    utils.qs('#exportAudit',panel).addEventListener('click',()=>{ audit.exportCSV(); });
  },{roles:['Y√∂netici','Muhasebe']});

  // Settings view
  router.addRoute('settings', async function(view){
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<h2>Ayarlar</h2><div class="small">Uygulama ayarlarƒ±</div><div style="margin-top:12px" class="grid"><div class="panel"><h3>Genel</h3><div class="form"><label class="label">Klinik Adƒ± <input class="input" id="clinicNameInp" value="${utils.escapeHtml(localStorage.getItem('clinic_name')||'√ñrnek Klinik')}"/></label><label class="label">Dil <select id="langSel"><option value="tr">T√ºrk√ße</option><option value="en">English</option></select></label><div style="text-align:right"><button class="btn btn--primary" id="saveSettings">Kaydet</button></div></div></div><div class="panel"><h3>G√ºvenlik</h3><div class="form"><label class="label">Oturum Zaman A≈üƒ±mƒ± (dk) <input class="input" id="sessionTimeout" type="number" value="${(auth.setSessionTimeout||30).toString().padStart(2,'0')}"/></label><button class="btn" id="btnClearLocal">Local Storage Temizle</button></div></div></div>`;
    view.appendChild(panel);
    // init
    utils.qs('#langSel',panel).value = i18n.getLang();
    utils.qs('#saveSettings',panel).addEventListener('click',()=>{ const name = utils.qs('#clinicNameInp').value; const lang = utils.qs('#langSel').value; localStorage.setItem('clinic_name',name); i18n.setLang(lang); ui.toast('Ayarlar kaydedildi'); location.reload(); });
    utils.qs('#btnClearLocal',panel).addEventListener('click',()=>{ ui.confirm('Local storage temizlensin mi? (yerel demo verileri silinir)',async ok=>{ if(ok){ localStorage.clear(); ui.toast('Temizlendi'); } }); });
  },{roles:[]});

  /* ========================
     PWA & Service Worker runtime generation (single file)
     - Create manifest and service worker via Blob and register
     ======================== */
  const pwa = (function(){
    async function register(){
      if('serviceWorker' in navigator){
        // create manifest dynamically
        const manifest = {name:'Klinik Y√∂netim',short_name:'Klinik',start_url:'./',display:'standalone',background_color:'#ffffff',theme_color:'#0b76ff',icons:[
          {src:'data:image/svg+xml;base64,'+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192"><rect width="100%" height="100%" fill="#0b76ff"/><text x="50%" y="50%" font-size="64" fill="white" text-anchor="middle" dominant-baseline="central">K</text></svg>'),sizes:'192x192',type:'image/svg+xml'},
          {src:'data:image/svg+xml;base64,'+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="#0b76ff"/><text x="50%" y="50%" font-size="160" fill="white" text-anchor="middle" dominant-baseline="central">K</text></svg>'),sizes:'512x512',type:'image/svg+xml'}
        ]};
        const manBlob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
        const manURL = URL.createObjectURL(manBlob);
        const link = document.createElement('link'); link.rel='manifest'; link.href=manURL; document.head.appendChild(link);

        // create service worker script dynamically
        const swCode = `
          const CACHE_NAME = 'clinic_cache_v1';
          const PRECACHE = ['.','./index.html'];
          self.addEventListener('install', (e)=>{ e.waitUntil(caches.open(CACHE_NAME).then(cache=>cache.addAll(PRECACHE))); self.skipWaiting(); });
          self.addEventListener('activate', (e)=>{ clients.claim(); });
          self.addEventListener('fetch', (e)=>{ const url = new URL(e.request.url); if(url.origin===location.origin){ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{ const c = res.clone(); caches.open(CACHE_NAME).then(cache=>cache.put(e.request,c)); return res; }))); }});
          self.addEventListener('push', (e)=>{ const data = e.data?.text()||'Bildirim'; self.registration.showNotification('Klinik', {body:data}); });
        `;
        const swBlob = new Blob([swCode],{type:'application/javascript'});
        const swURL = URL.createObjectURL(swBlob);
        try{
          const reg = await navigator.serviceWorker.register(swURL);
          utils.qs('#swStatus').textContent = 'Kayƒ±tlƒ±';
          ui.toast('PWA servis √ßalƒ±≈üanƒ± kaydoldu');
        }catch(e){ utils.qs('#swStatus').textContent = 'Hata'; ui.toast('SW kaydolamadƒ±'); }
      }
    }
    return {register};
  })();

  /* ========================
     Keyboard shortcuts and global handlers
     ======================== */
  (function(){
    window.addEventListener('keydown', (e)=>{
      if(e.key==='n' && (document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA')){ e.preventDefault(); document.getElementById('btnNewPatient')?.click(); }
      if(e.key==='a' && (document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA')){ e.preventDefault(); document.getElementById('btnNewAppt')?.click(); }
      if(e.key==='f'){ utils.qs('#patientSearch')?.focus(); }
      if(e.key==='s' && (document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA')){ /* save current form if any */ }
      if(e.ctrlKey && e.key==='k'){ e.preventDefault(); utils.qs('#patientSearch')?.focus(); }
    });
  })();

  /* ========================
     Initial boot: register event handlers, seed sample data, mount default view
     ======================== */
  (async function init(){
    // show app title
    document.getElementById('clinicName').textContent = localStorage.getItem('clinic_name') || '√ñrnek Klinik';
    // wire nav
    document.querySelectorAll('.nav__item').forEach(n=> n.addEventListener('click', ()=>{ router.navigate(n.dataset.route); }));
    // top actions
    document.getElementById('btnLang').addEventListener('click', ()=>{ const next = i18n.getLang()==='tr'?'en':'tr'; i18n.setLang(next); ui.toast('Dil: '+next); location.reload(); });
    document.getElementById('btnToggleTheme').addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); ui.toast('Tema deƒüi≈ütirildi'); });
    // quick actions
    document.getElementById('btnNewPatient').addEventListener('click', ()=>{ router.navigate('patients'); setTimeout(()=>utils.qs('#addPatientBtn')?.click(),200); });
    document.getElementById('btnNewAppt').addEventListener('click', ()=>{ router.navigate('appointments'); setTimeout(()=>utils.qs('#btnNewAppt2')?.click(),200); });
    document.getElementById('btnSearch').addEventListener('click', ()=>{ router.navigate('patients'); setTimeout(()=>utils.qs('#patientSearch')?.focus(),200); });
    document.getElementById('btnDiagnostics').addEventListener('click', ()=>{ showDiagnostics(); });
    // pwa register
    pwa.register();
    // create initial admin user if none
    const users = await db.getAll('users');
    if(users.length===0){
      await auth.register({name:'Admin',email:'admin@klinik.local',password:'Admin123!',role:'Y√∂netici'});
      ui.toast('√ñrnek y√∂netici olu≈üturuldu: admin@klinik.local / Admin123!');
    }
    // seed sample data if absent
    const pats = await db.getAll('patients');
    if(pats.length<50){ await seeder.generatePatients(150); await seeder.generateAppts(250); ui.toast('√ñrnek veriler olu≈üturuldu'); }
    // navigate to last or dashboard
    const h = location.hash.replace('#!/','') || 'dashboard';
    await router.navigate(h);
  })();

  /* ========================
     Diagnostics panel
     ======================== */
  async function showDiagnostics(){
    const indexInfo = await (db.getAll('patients').then(p=>`Patients: ${p.length}`).catch(()=>'')) + ' | ' + (await db.getAll('appts').then(a=>`Appts: ${a.length}`));
    const sw = navigator.serviceWorker.controller? 'active':'none';
    ui.modal(`<div class="small"><p>Diagnostics</p><ul><li>IndexedDB: ${indexInfo}</li><li>Service Worker: ${sw}</li><li>Notifications: ${Notification.permission}</li><li>Storage estimate: <span id="storageEst">...</span></li></ul><div style="text-align:right"><button class="btn" id="btnCloseDiag">Kapat</button></div></div>`,'Sistem Diagnostik');
    // storage estimate
    if(navigator.storage && navigator.storage.estimate){
      const est = await navigator.storage.estimate();
      utils.qs('#storageEst').textContent = `${utils.readableBytes(est.usage||0)} of ${utils.readableBytes(est.quota||0)}`;
    }
    setTimeout(()=>{ utils.qs('#btnCloseDiag')?.addEventListener('click', ()=>{ document.getElementById('modalBackdrop').style.display='none'; }); },50);
  }

  /* ========================
     Export/Import mappings and wizards (simplified)
     ======================== */
  async function importJSONFile(file,storeName,fieldMap){
    const text = await file.text(); const data = JSON.parse(text);
    for(const item of data){
      // simple mapping: if fieldMap provided, remap
      const obj = {};
      for(const k in item) obj[k] = item[k];
      await db.put(storeName,obj);
    }
    ui.toast('ƒ∞√ße aktarma tamamlandƒ±');
  }

  /* ========================
     Integration Points (stubs for e-mail/sms/whatsapp/e-Fatura)
     - Provide function signatures and sample payloads only.
     ======================== */
  const integrations = (function(){
    function createEmailPayload(to,subject,body){ return {to,subject,body,from:'no-reply@klinik.local'}; }
    function createSMSPayload(number,message){ return {to:number,message}; }
    function createWhatsAppPayload(number,message){ return {to:number,message}; }
    function createEFaturaPayload(invoice){ return {invoice}; }
    return {createEmailPayload,createSMSPayload,createWhatsAppPayload,createEFaturaPayload};
  })();

  /* ========================
     End of JS IIFE
     ======================== */
})(window,document);
</script>

<!--
Kurulum & Notlar:
- GitHub repo'ye tek dosya olarak ekleyin: index.html
- GitHub Pages veya herhangi bir static host √ºzerinde √ßalƒ±≈üƒ±r.
- Demo: Veriler tarayƒ±cƒ±ya kaydedilir (IndexedDB). √úretim i√ßin backend gereklidir.
- Rol & Yetki Matrisi: Y√∂netici (Y√∂netici), Hekim (Hekim), Resepsiyon (Resepsiyon), Muhasebe (Muhasebe), Asistan (Asistan), Stajyer (Stajyer)
- Kƒ±sayollar: N yeni hasta, A yeni randevu, F arama, S sistem testi, Ctrl+K global arama.
- Entegrasyon noktalarƒ±: integrations.createEmailPayload(to,subject,body) vb. (√ßaƒürƒ± yok).
-->

</body>
</html>
